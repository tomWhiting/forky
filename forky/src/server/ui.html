<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forky - Claude Fork Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            surface: '#1a1a1a',
            bg: '#0f0f0f',
            border: '#2a2a2a',
            muted: '#666',
            accent: '#3b82f6',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .message-enter { animation: slideIn 0.15s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-bg text-gray-100 h-screen flex flex-col">
  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-3 border-b border-border bg-surface">
    <div class="flex items-center gap-3">
      <h1 class="text-lg font-semibold">Forky</h1>
      <span id="connection-status" class="text-xs px-2 py-0.5 rounded bg-red-900/50 text-red-400">Disconnected</span>
    </div>
    <div class="text-sm text-muted">
      <span id="project-count">0</span> projects &middot; <span id="fork-count">0</span> forks
    </div>
  </header>

  <!-- Main layout -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar: Projects & Forks -->
    <aside class="w-72 border-r border-border bg-surface flex flex-col">
      <div class="p-3 border-b border-border">
        <h2 class="text-sm font-medium text-muted uppercase tracking-wide">Projects</h2>
      </div>
      <div id="project-list" class="flex-1 overflow-y-auto scrollbar-thin">
        <div class="p-4 text-center text-muted text-sm">Loading...</div>
      </div>
    </aside>

    <!-- Main content: Conversation Stream -->
    <main class="flex-1 flex flex-col bg-bg">
      <!-- Fork header -->
      <div id="fork-header" class="px-4 py-3 border-b border-border bg-surface hidden">
        <div class="flex items-center justify-between gap-4">
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xs text-muted shrink-0">Fork:</span>
              <code id="fork-title" class="text-xs font-mono text-accent select-all break-all"></code>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-muted shrink-0">Session:</span>
              <code id="fork-info" class="text-xs font-mono text-gray-400 select-all break-all"></code>
            </div>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <span id="fork-status" class="text-xs px-2 py-0.5 rounded"></span>
            <button id="interrupt-btn" class="px-3 py-1.5 text-sm bg-red-900/50 hover:bg-red-900 text-red-300 rounded transition hidden">
              Interrupt
            </button>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div id="messages" class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-3">
        <div class="text-center text-muted text-sm py-8">
          Select a fork to view conversation
        </div>
      </div>

      <!-- Input area -->
      <div id="input-area" class="border-t border-border p-4 bg-surface hidden">
        <form id="send-form" class="flex gap-2">
          <input
            type="text"
            id="message-input"
            placeholder="Send a message to this fork..."
            class="flex-1 bg-bg border border-border rounded px-3 py-2 text-sm focus:outline-none focus:border-accent"
          >
          <button type="submit" class="px-4 py-2 bg-accent hover:bg-blue-600 text-white text-sm rounded transition">
            Send
          </button>
        </form>
      </div>
    </main>
  </div>

  <script>
    // State
    let state = {
      projects: [],
      forks: [],
      selectedProject: null,
      selectedFork: null,
      events: [],
      ws: null,
    };

    // DOM refs
    const $projectList = document.getElementById('project-list');
    const $messages = document.getElementById('messages');
    const $forkHeader = document.getElementById('fork-header');
    const $forkTitle = document.getElementById('fork-title');
    const $forkInfo = document.getElementById('fork-info');
    const $forkStatus = document.getElementById('fork-status');
    const $inputArea = document.getElementById('input-area');
    const $interruptBtn = document.getElementById('interrupt-btn');
    const $sendForm = document.getElementById('send-form');
    const $messageInput = document.getElementById('message-input');
    const $connectionStatus = document.getElementById('connection-status');
    const $projectCount = document.getElementById('project-count');
    const $forkCount = document.getElementById('fork-count');

    // API helpers
    async function fetchJson(url) {
      const res = await fetch(url);
      return res.json();
    }

    async function patchJson(url, data) {
      const res = await fetch(url, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      return res.json();
    }

    // Load data
    async function loadForks() {
      state.forks = await fetchJson('/api/forks');

      // Extract unique projects
      const projectSet = new Set(state.forks.map(f => f.project_path));
      state.projects = Array.from(projectSet).sort();

      $projectCount.textContent = state.projects.length;
      $forkCount.textContent = state.forks.length;

      renderProjects();
    }

    async function loadEvents(projectPath, forkId) {
      const params = new URLSearchParams({
        project_path: projectPath,
        fork_id: forkId,
        limit: '500',
      });
      state.events = await fetchJson(`/api/events?${params}`);
      renderMessages();
    }

    // Render functions
    function renderProjects() {
      if (state.projects.length === 0) {
        $projectList.innerHTML = '<div class="p-4 text-center text-muted text-sm">No projects yet</div>';
        return;
      }

      $projectList.innerHTML = state.projects.map(project => {
        const projectForks = state.forks.filter(f => f.project_path === project);
        const isSelected = state.selectedProject === project;
        const shortPath = project.split('/').slice(-2).join('/');

        return `
          <div class="border-b border-border">
            <button
              class="w-full px-3 py-2 text-left hover:bg-bg/50 flex items-center justify-between ${isSelected ? 'bg-bg' : ''}"
              onclick="selectProject('${escapeAttr(project)}')"
            >
              <span class="text-sm truncate" title="${escapeAttr(project)}">${escapeHtml(shortPath)}</span>
              <span class="text-xs text-muted">${projectForks.length}</span>
            </button>
            ${isSelected ? renderForkList(projectForks) : ''}
          </div>
        `;
      }).join('');
    }

    function renderForkList(forks) {
      if (forks.length === 0) return '<div class="px-3 py-2 text-xs text-muted">No forks</div>';

      return `
        <div class="bg-bg/30">
          ${forks.map(fork => {
            const isSelected = state.selectedFork?.fork_id === fork.fork_id;
            const statusColor = getStatusColor(fork.status);

            return `
              <button
                class="w-full px-3 py-2 text-left hover:bg-bg ${isSelected ? 'bg-accent/20' : ''}"
                onclick="selectFork('${escapeAttr(fork.project_path)}', '${escapeAttr(fork.fork_id)}')"
              >
                <div class="flex items-center gap-2 mb-1">
                  <span class="w-1.5 h-1.5 rounded-full ${statusColor} shrink-0"></span>
                  <span class="text-xs font-mono break-all">${escapeHtml(fork.fork_id)}</span>
                </div>
                <div class="text-xs text-muted pl-3">${fork.event_count} events</div>
              </button>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderMessages() {
      if (state.events.length === 0) {
        $messages.innerHTML = '<div class="text-center text-muted text-sm py-8">No events yet</div>';
        return;
      }

      // Sort events by uuid (UUIDv7 is time-ordered)
      const sortedEvents = [...state.events].sort((a, b) =>
        (a.uuid || '').localeCompare(b.uuid || '')
      );

      $messages.innerHTML = sortedEvents.map(event => renderEvent(event)).join('');
      $messages.scrollTop = $messages.scrollHeight;
    }

    function renderEvent(event) {
      const type = event.event_type;

      // User message
      if (type === 'user') {
        return `
          <div class="message-enter flex gap-3">
            <div class="w-7 h-7 rounded bg-green-900/50 flex items-center justify-center text-green-400 text-xs shrink-0">U</div>
            <div class="flex-1 bg-surface rounded px-3 py-2">
              <div class="text-sm whitespace-pre-wrap">${escapeHtml(event.message || '')}</div>
            </div>
          </div>
        `;
      }

      // Assistant message
      if (type === 'assistant') {
        const content = [];

        if (event.thinking) {
          content.push(`
            <details class="mb-2">
              <summary class="text-xs text-muted cursor-pointer hover:text-gray-400">Thinking...</summary>
              <div class="mt-1 pl-3 border-l border-border text-xs text-muted whitespace-pre-wrap">${escapeHtml(event.thinking)}</div>
            </details>
          `);
        }

        if (event.message) {
          content.push(`<div class="text-sm whitespace-pre-wrap">${escapeHtml(event.message)}</div>`);
        }

        if (event.tool_uses && Array.isArray(event.tool_uses)) {
          for (const tool of event.tool_uses) {
            content.push(`
              <div class="mt-2 text-xs bg-bg rounded px-2 py-1.5 border border-border">
                <span class="text-accent">${escapeHtml(tool.name || 'tool')}</span>
                ${tool.input ? `<span class="text-muted ml-2">${escapeHtml(truncate(JSON.stringify(tool.input), 100))}</span>` : ''}
              </div>
            `);
          }
        }

        return `
          <div class="message-enter flex gap-3">
            <div class="w-7 h-7 rounded bg-accent/30 flex items-center justify-center text-accent text-xs shrink-0">A</div>
            <div class="flex-1 bg-surface rounded px-3 py-2">
              ${content.join('')}
            </div>
          </div>
        `;
      }

      // Result
      if (type === 'result') {
        const cost = event.total_cost_usd || event.cost_usd;
        return `
          <div class="message-enter flex gap-3">
            <div class="w-7 h-7 rounded bg-purple-900/50 flex items-center justify-center text-purple-400 text-xs shrink-0">R</div>
            <div class="flex-1 bg-surface rounded px-3 py-2">
              <div class="text-sm whitespace-pre-wrap">${escapeHtml(event.result || event.message || 'Completed')}</div>
              ${cost ? `<div class="mt-1 text-xs text-muted">Cost: $${cost.toFixed(4)}</div>` : ''}
            </div>
          </div>
        `;
      }

      // System / Other
      return `
        <div class="message-enter flex gap-3 opacity-60">
          <div class="w-7 h-7 rounded bg-gray-800 flex items-center justify-center text-gray-500 text-xs shrink-0">S</div>
          <div class="flex-1 text-xs text-muted">
            <span class="font-medium">${escapeHtml(type)}</span>
            ${event.subtype ? `<span class="ml-1 opacity-75">(${escapeHtml(event.subtype)})</span>` : ''}
          </div>
        </div>
      `;
    }

    // Selection handlers
    function selectProject(project) {
      state.selectedProject = state.selectedProject === project ? null : project;
      state.selectedFork = null;
      state.events = [];
      renderProjects();
      renderMessages();
      $forkHeader.classList.add('hidden');
      $inputArea.classList.add('hidden');
    }

    function selectFork(projectPath, forkId) {
      const fork = state.forks.find(f => f.fork_id === forkId);
      if (!fork) return;

      state.selectedFork = fork;
      loadEvents(projectPath, forkId);

      // Update header
      $forkHeader.classList.remove('hidden');
      $inputArea.classList.remove('hidden');
      $forkTitle.textContent = forkId;
      $forkInfo.textContent = fork.session_id || '(not set)';

      const statusColor = getStatusBadgeClasses(fork.status);
      $forkStatus.textContent = fork.status;
      $forkStatus.className = `text-xs px-2 py-0.5 rounded ${statusColor}`;

      $interruptBtn.classList.toggle('hidden', fork.status !== 'running');

      renderProjects();
    }

    // Helpers
    function getStatusColor(status) {
      switch (status) {
        case 'running': return 'bg-green-500';
        case 'completed': return 'bg-blue-500';
        case 'failed': return 'bg-red-500';
        case 'interrupted': return 'bg-yellow-500';
        default: return 'bg-gray-500';
      }
    }

    function getStatusBadgeClasses(status) {
      switch (status) {
        case 'running': return 'bg-green-900/50 text-green-400';
        case 'completed': return 'bg-blue-900/50 text-blue-400';
        case 'failed': return 'bg-red-900/50 text-red-400';
        case 'interrupted': return 'bg-yellow-900/50 text-yellow-400';
        default: return 'bg-gray-800 text-gray-400';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeAttr(text) {
      if (!text) return '';
      return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function truncate(text, len) {
      return text.length > len ? text.slice(0, len) + '...' : text;
    }

    // WebSocket
    function connectWebSocket() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      state.ws = new WebSocket(`${protocol}//${location.host}/ws`);

      state.ws.onopen = () => {
        $connectionStatus.textContent = 'Connected';
        $connectionStatus.className = 'text-xs px-2 py-0.5 rounded bg-green-900/50 text-green-400';
      };

      state.ws.onclose = () => {
        $connectionStatus.textContent = 'Disconnected';
        $connectionStatus.className = 'text-xs px-2 py-0.5 rounded bg-red-900/50 text-red-400';
        setTimeout(connectWebSocket, 2000);
      };

      state.ws.onmessage = (msg) => {
        try {
          const data = JSON.parse(msg.data);
          handleBroadcast(data);
        } catch (e) {
          console.error('WS parse error:', e);
        }
      };
    }

    function handleBroadcast(data) {
      // Check if this is a new fork (system init event)
      if (data.event?.event_type === 'system' && data.event?.subtype === 'init') {
        loadForks();
        return;
      }

      // Add event if it's for the selected fork
      if (state.selectedFork && data.fork_id === state.selectedFork.fork_id) {
        state.events.push(data.event);
        renderMessages();
      }

      // Update event count in sidebar
      const fork = state.forks.find(f => f.fork_id === data.fork_id);
      if (fork) {
        fork.event_count++;
        renderProjects();
      }
    }

    // Event handlers
    $interruptBtn.addEventListener('click', async () => {
      if (!state.selectedFork) return;

      await patchJson(`/api/forks/${state.selectedFork.fork_id}`, {
        project_path: state.selectedFork.project_path,
        status: 'interrupted',
      });

      state.selectedFork.status = 'interrupted';
      renderProjects();
      selectFork(state.selectedFork.project_path, state.selectedFork.fork_id);
    });

    $sendForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = $messageInput.value.trim();
      if (!message || !state.selectedFork) return;

      // TODO: Implement sending messages to forks
      // This would require spawning a new Claude process or adding stdin pipe support
      alert('Message sending not yet implemented. Fork ID: ' + state.selectedFork.fork_id);
      $messageInput.value = '';
    });

    // Initialize
    async function init() {
      await loadForks();
      connectWebSocket();

      // Auto-refresh every 30s
      setInterval(loadForks, 30000);
    }

    init();
  </script>
</body>
</html>
